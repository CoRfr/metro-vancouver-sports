<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Vancouver Sports Schedules</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--sport-gradient, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
            min-height: 100vh;
            padding: 20px;
            transition: background 0.5s ease;
        }

        body.sport-skating {
            --sport-gradient: linear-gradient(135deg, #74b9ff 0%, #a29bfe 50%, #dfe6e9 100%);
            --sport-accent: #74b9ff;
        }

        body.sport-swimming {
            --sport-gradient: linear-gradient(135deg, #00cec9 0%, #0984e3 50%, #6c5ce7 100%);
            --sport-accent: #00cec9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label, .filter-item > label {
            font-weight: 600;
            color: #555;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="text"] {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background: #fafafa;
            width: 100%;
        }

        select:hover, input[type="text"]:hover {
            border-color: #667eea;
            background: white;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .location-row {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .location-row input {
            flex: 1;
        }

        #useLocationBtn, #facilityMapBtn {
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #useLocationBtn:hover, #facilityMapBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        #facilityMapBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .calendar-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .calendar-header h2 {
            color: #333;
            font-size: 1.8rem;
        }

        .calendar-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 8px;
        }

        .view-toggle button {
            padding: 8px 16px;
            background: transparent;
            color: #666;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .view-toggle button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.3s;
        }

        .calendar-nav button:hover {
            opacity: 0.9;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .calendar-grid.day-view {
            display: block;
        }

        .calendar-grid.week-view {
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 700;
            color: #667eea;
            padding: 10px;
            font-size: 0.9rem;
        }

        .calendar-day {
            min-height: 120px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            background: #fafafa;
            transition: all 0.3s;
        }

        /* Day view timeline styles */
        .day-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .day-view-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .day-picker {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .day-picker-nav {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .day-picker button {
            padding: 10px 14px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .day-picker button:hover {
            background: #e8e8e8;
            transform: translateY(-1px);
        }

        .day-picker button.nav-btn {
            padding: 10px 12px;
            background: white;
            border: 2px solid #e0e0e0;
        }

        .day-picker button.nav-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .day-picker-days {
            display: flex;
            gap: 4px;
            background: #f0f0f0;
            padding: 4px;
            border-radius: 10px;
        }

        .day-picker-days button {
            min-width: 70px;
            padding: 8px 12px;
            background: transparent;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .day-picker-days button .day-name {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #888;
            font-weight: 500;
        }

        .day-picker-days button .day-num {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
        }

        .day-picker-days button:hover {
            background: rgba(255,255,255,0.8);
        }

        .day-picker-days button.selected {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .day-picker-days button.is-today {
            border: 2px solid #667eea;
        }

        .day-picker-days button.is-today .day-name {
            color: #667eea;
        }

        .day-picker-days button.selected.is-today {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .day-picker-days button.selected.is-today .day-name,
        .day-picker-days button.selected.is-today .day-num {
            color: white;
        }

        .day-picker-days button.is-weekend {
            background: rgba(102, 126, 234, 0.08);
        }

        .day-picker-days button.is-weekend .day-name {
            color: #667eea;
        }

        .day-picker-days button.is-weekend.selected {
            background: rgba(102, 126, 234, 0.15);
        }

        .day-picker input[type="date"] {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .day-picker input[type="date"]:hover {
            border-color: #667eea;
        }

        .timeline-container {
            position: relative;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            overflow: hidden;
        }

        .timeline-hours {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 60px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            z-index: 1;
        }

        .timeline-hour {
            height: 60px;
            padding: 4px 8px;
            font-size: 0.75rem;
            color: #666;
            border-bottom: 1px solid #eee;
        }

        .timeline-grid {
            margin-left: 70px;
            margin-right: 10px;
            position: relative;
            min-height: 720px;
        }

        .timeline-hour-line {
            height: 60px;
            border-bottom: 1px solid #f0f0f0;
        }

        .timeline-event {
            position: absolute;
            border-radius: 6px;
            padding: 6px 8px;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 2;
            box-sizing: border-box;
            font-size: 0.85rem;
        }

        .timeline-event:hover {
            transform: translateX(3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .timeline-event.public {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #1976d2;
        }

        .timeline-event.family {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-left: 4px solid #7b1fa2;
        }

        .timeline-event.hockey {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ef6c00;
        }

        .timeline-event.figure {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
            border-left: 4px solid #c2185b;
        }

        .timeline-event.discount {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #388e3c;
        }

        .timeline-event-time {
            font-weight: 700;
            font-size: 0.75rem;
            margin-bottom: 2px;
        }

        .timeline-event-name {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .timeline-event-location {
            font-size: 0.7rem;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .no-sessions-message {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-sessions-message .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .timeline-now-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #e74c3c;
            z-index: 10;
        }

        .timeline-now-line::before {
            content: 'NOW';
            position: absolute;
            left: -45px;
            top: -8px;
            font-size: 0.7rem;
            font-weight: 700;
            color: #e74c3c;
            background: white;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .timeline-event.past {
            opacity: 0.5;
            filter: grayscale(30%);
        }

        .timeline-event.past::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.3);
            pointer-events: none;
        }

        .calendar-day:hover {
            border-color: #667eea;
            background: white;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .day-number {
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .day-sessions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .session-pill {
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: transform 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-pill:hover {
            transform: scale(1.05);
        }

        .session-pill.public {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }

        .session-pill.family {
            background: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #ce93d8;
        }

        .session-pill.hockey {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffb74d;
        }

        .session-pill.figure {
            background: #fce4ec;
            color: #c2185b;
            border: 1px solid #f48fb1;
        }

        .session-pill.discount {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #81c784;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .session-detail {
            margin-bottom: 15px;
        }

        .session-detail strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
        }

        .add-to-calendar {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s;
            margin-top: 10px;
        }

        .add-to-calendar:hover {
            opacity: 0.9;
        }

        .info-box {
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .info-box summary {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #667eea;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-box summary::-webkit-details-marker {
            display: none;
        }

        .info-box summary::before {
            content: '‚ñ∂';
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .info-box[open] summary::before {
            transform: rotate(90deg);
        }

        .info-box-content {
            padding: 0 20px 20px;
        }

        .info-box p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .info-box a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        .data-sources {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .data-sources h4 {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }

        .data-source-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .data-source-city {
            font-weight: 600;
            color: #333;
            min-width: 120px;
        }

        .data-source-count {
            font-size: 0.8rem;
            color: #667eea;
            font-weight: 600;
            min-width: 50px;
        }

        .data-source-info {
            color: #666;
        }

        /* Map modal styles */
        .map-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
        }

        .map-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-modal-content {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .map-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .map-modal-header h3 {
            color: #333;
            font-size: 1.2rem;
        }

        .map-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        #facilityMap {
            flex: 1;
            min-height: 400px;
        }

        .map-legend {
            padding: 10px 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.vancouver { background: #1976d2; }
        .legend-dot.burnaby { background: #7b1fa2; }
        .legend-dot.northvan { background: #388e3c; }
        .legend-dot.westvan { background: #00796b; }
        .legend-dot.newwest { background: #c2185b; }
        .legend-dot.outdoor { background: #ef6c00; }

        .view-map-btn {
            padding: 12px 15px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .view-map-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 153, 142, 0.4);
        }

        .activity-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            align-items: center;
        }

        .activity-label {
            font-weight: 600;
            color: #555;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 10px;
        }

        .activity-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .activity-checkbox:hover {
            background: #e8e8e8;
        }

        .activity-checkbox:has(input:checked) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .activity-checkbox.all-toggle {
            background: #333;
            color: white;
            font-weight: 600;
        }

        .activity-checkbox.all-toggle:has(input:checked) {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .activity-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Metro Vancouver Public Skating</h1>
            <p class="subtitle">Vancouver, Burnaby, North & West Vancouver, New Westminster</p>
        </header>

        <details class="info-box">
            <summary>About this schedule</summary>
            <div class="info-box-content">
                <p id="scheduleStatus">Loading schedule data...</p>
                <div class="data-sources">
                    <h4>Data Sources</h4>
                    <div class="data-source-item" data-city="Vancouver">
                        <span class="data-source-city">Vancouver</span>
                        <span class="data-source-count"></span>
                        <span class="data-source-info"><a href="https://anc.ca.apm.activecommunities.com/vancouver/calendars?onlineSiteId=0&defaultCalendarId=3&displayType=0&view=2" target="_blank">ActiveNet Calendar API</a></span>
                    </div>
                    <div class="data-source-item" data-city="Burnaby">
                        <span class="data-source-city">Burnaby</span>
                        <span class="data-source-count"></span>
                        <span class="data-source-info"><a href="https://www.burnaby.ca/recreation-and-arts/activities-and-registration/daily-activities" target="_blank">burnaby.ca</a> (weekly schedules)</span>
                    </div>
                    <div class="data-source-item" data-city="North Vancouver">
                        <span class="data-source-city">North Vancouver</span>
                        <span class="data-source-count"></span>
                        <span class="data-source-info"><a href="https://www.nvrc.ca/drop-in-schedules?activity=551" target="_blank">NVRC Drop-in Schedules</a></span>
                    </div>
                    <div class="data-source-item" data-city="West Vancouver">
                        <span class="data-source-city">West Vancouver</span>
                        <span class="data-source-count"></span>
                        <span class="data-source-info"><a href="https://westvancouver.ca/parks-recreation/recreation-programs-services/daily-activities-search-results" target="_blank">westvancouver.ca</a></span>
                    </div>
                    <div class="data-source-item" data-city="New Westminster">
                        <span class="data-source-city">New Westminster</span>
                        <span class="data-source-count"></span>
                        <span class="data-source-info"><a href="https://cityofnewwestminster.perfectmind.com/23693/Clients/BookMe4BookingPages/Classes?calendarId=db250b43-ef6b-43c5-979e-3f3d1dab2d67" target="_blank">PerfectMind</a></span>
                    </div>
                    <div class="data-source-item" data-city="Outdoor">
                        <span class="data-source-city">Outdoor Rinks</span>
                        <span class="data-source-count"></span>
                        <span class="data-source-info"><a href="https://www.robsonsquare.com/" target="_blank">Robson Square</a>, <a href="https://www.cnv.org/parks-recreation/the-shipyards/skate-plaza" target="_blank">The Shipyards</a></span>
                    </div>
                </div>
            </div>
        </details>

        <div class="controls">
            <div class="filter-group">
                <div class="filter-item">
                    <label for="sportFilter">Sport</label>
                    <select id="sportFilter">
                        <option value="skating">Ice Skating</option>
                        <option value="swimming" disabled>Swimming (coming soon)</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label for="cityFilter">City</label>
                    <select id="cityFilter">
                        <option value="all">All Cities</option>
                        <option value="Vancouver">Vancouver</option>
                        <option value="Burnaby">Burnaby</option>
                        <option value="North Vancouver">North Vancouver</option>
                        <option value="West Vancouver">West Vancouver</option>
                        <option value="New Westminster">New Westminster</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label for="facilityFilter">Facility</label>
                    <div class="location-row">
                        <select id="facilityFilter">
                            <option value="all">All Facilities</option>
                        </select>
                        <button id="facilityMapBtn" title="View on map" disabled>üìç</button>
                    </div>
                </div>

                <div class="filter-item">
                    <label for="postalCode">Location</label>
                    <div class="location-row">
                        <input type="text" id="postalCode" placeholder="Postal code">
                        <button id="useLocationBtn">üìç Locate</button>
                    </div>
                </div>

                <div class="filter-item">
                    <label for="distanceFilter">Distance</label>
                    <select id="distanceFilter">
                        <option value="999">Any Distance</option>
                        <option value="2">2 km</option>
                        <option value="5">5 km</option>
                        <option value="10" selected>10 km</option>
                        <option value="15">15 km</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label>&nbsp;</label>
                    <button class="view-map-btn" id="viewMapBtn">View Map</button>
                </div>
            </div>

            <div class="activity-filters" id="activityFilters">
                <strong>Activity Types:</strong>
                <label class="activity-checkbox">
                    <input type="checkbox" id="activityPublic" value="Public Skating" checked>
                    <span>Public Skating</span>
                </label>
                <label class="activity-checkbox">
                    <input type="checkbox" id="activityFamily" value="Family Skate" checked>
                    <span>Family Skating</span>
                </label>
                <label class="activity-checkbox">
                    <input type="checkbox" id="activityHockey" value="Family Hockey">
                    <span>Family Hockey</span>
                </label>
                <label class="activity-checkbox">
                    <input type="checkbox" id="activityFigure" value="Figure Skating" checked>
                    <span>Figure Skating</span>
                </label>
            </div>
        </div>

        <div class="calendar-container">
            <div class="calendar-header">
                <h2 id="currentMonth"></h2>
                <div class="calendar-controls">
                    <div class="view-toggle">
                        <button id="dayViewBtn" class="active">Day</button>
                        <button id="weekViewBtn">Week</button>
                        <button id="monthViewBtn">Month</button>
                    </div>
                    <div class="calendar-nav">
                        <button id="prevBtn">‚Üê Previous</button>
                        <button id="nextBtn">Next ‚Üí</button>
                    </div>
                </div>
            </div>
            <div class="calendar-grid day-view" id="calendar"></div>
        </div>
    </div>

    <div class="modal" id="sessionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <div class="map-modal" id="mapModal">
        <div class="map-modal-content">
            <div class="map-modal-header">
                <h3 id="mapTitle">Facilities with Upcoming Sessions</h3>
                <button class="map-modal-close" id="mapModalClose">√ó</button>
            </div>
            <div id="facilityMap"></div>
            <div class="map-legend">
                <div class="legend-item"><div class="legend-dot vancouver"></div> Vancouver</div>
                <div class="legend-item"><div class="legend-dot burnaby"></div> Burnaby</div>
                <div class="legend-item"><div class="legend-dot northvan"></div> North Vancouver</div>
                <div class="legend-item"><div class="legend-dot westvan"></div> West Vancouver</div>
                <div class="legend-item"><div class="legend-dot newwest"></div> New Westminster</div>
                <div class="legend-item"><div class="legend-dot outdoor"></div> Outdoor Rinks</div>
            </div>
        </div>
    </div>

    <script>
        // Sport configuration
        const SPORTS_CONFIG = {
            skating: {
                name: 'Ice Skating',
                dataUrl: './data/schedules.json',
                activityTypes: [
                    { id: 'activityAll', value: '__all__', label: 'All', checked: false, isAll: true },
                    { id: 'activityPublic', value: 'Public Skating', label: 'Public Skating', checked: true },
                    { id: 'activityDiscount', value: '__discount__', label: 'Discount/Free Only', checked: true },
                    { id: 'activityFamily', value: 'Family Skate', label: 'Family Skating', checked: true },
                    { id: 'activityFigure', value: 'Figure Skating', label: 'Figure Skating', checked: false },
                    { id: 'activityLessons', value: 'Skating Lessons', label: 'Lessons', checked: false },
                    { id: 'activityPractice', value: 'Practice', label: 'Practice', checked: false },
                    { id: 'activityHockey', value: 'Hockey', label: 'Hockey', checked: false },
                    { id: 'activityFamilyHockey', value: 'Family Hockey', label: 'Family Hockey', checked: false },
                    { id: 'activityDropinHockey', value: 'Drop-in Hockey', label: 'Drop-in Hockey', checked: false },
                    { id: 'activityOther', value: 'Skating', label: 'Other', checked: false },
                ]
            },
            swimming: {
                name: 'Swimming',
                dataUrl: './data/swimming.json',
                activityTypes: [
                    { id: 'activityLap', value: 'Lap Swim', label: 'Lap Swim', checked: true },
                    { id: 'activityPublicSwim', value: 'Public Swim', label: 'Public Swim', checked: true },
                    { id: 'activityLessons', value: 'Lessons', label: 'Lessons', checked: false },
                    { id: 'activityAquafit', value: 'Aquafit', label: 'Aquafit', checked: false },
                ]
            }
        };

        let currentSport = 'skating';
        const USE_SAMPLE_DATA = false; // Set to true to use sample data for testing

        function getDataUrl() {
            return SPORTS_CONFIG[currentSport]?.dataUrl || './data/schedules.json';
        }
        
        const sampleSessions = [
            {
                facility: "Britannia Community Centre",
                city: "Vancouver",
                address: "1661 Napier St, Vancouver",
                lat: 49.2754,
                lng: -123.0719,
                date: "2026-01-15",
                startTime: "12:00",
                endTime: "13:30",
                type: "Public Skating"
            },
            {
                facility: "Hillcrest Centre",
                city: "Vancouver",
                address: "4575 Clancy Loranger Way, Vancouver",
                lat: 49.2438,
                lng: -123.1090,
                date: "2026-01-15",
                startTime: "15:00",
                endTime: "16:30",
                type: "Public Skating"
            },
            {
                facility: "Kerrisdale Arena",
                city: "Vancouver",
                address: "5851 West Boulevard, Vancouver",
                lat: 49.2337,
                lng: -123.1607,
                date: "2026-01-16",
                startTime: "14:00",
                endTime: "15:30",
                type: "Figure Skating"
            },
            {
                facility: "Bill Copeland Sports Centre",
                city: "Burnaby",
                address: "3676 Kensington Ave, Burnaby",
                lat: 49.2389,
                lng: -123.0042,
                date: "2026-01-16",
                startTime: "13:00",
                endTime: "14:30",
                type: "Public Skating"
            },
            {
                facility: "Kensington Arena",
                city: "Burnaby",
                address: "6050 McMurray Ave, Burnaby",
                lat: 49.2267,
                lng: -123.0036,
                date: "2026-01-17",
                startTime: "11:00",
                endTime: "12:30",
                type: "Family Skate"
            },
            {
                facility: "Sunset Community Centre",
                city: "Vancouver",
                address: "6810 Main St, Vancouver",
                lat: 49.2267,
                lng: -123.1003,
                date: "2026-01-17",
                startTime: "16:00",
                endTime: "17:30",
                type: "Family Hockey"
            },
            {
                facility: "Trout Lake Community Centre",
                city: "Vancouver",
                address: "3360 Victoria Dr, Vancouver",
                lat: 49.2544,
                lng: -123.0636,
                date: "2026-01-18",
                startTime: "10:00",
                endTime: "11:30",
                type: "Public Skating"
            },
            {
                facility: "Rosemary Brown Arena",
                city: "Burnaby",
                address: "5930 Humphries Ave, Burnaby",
                lat: 49.2258,
                lng: -122.9892,
                date: "2026-01-18",
                startTime: "14:30",
                endTime: "16:00",
                type: "Family Skate"
            },
            {
                facility: "Britannia Community Centre",
                city: "Vancouver",
                address: "1661 Napier St, Vancouver",
                lat: 49.2754,
                lng: -123.0719,
                date: "2026-01-20",
                startTime: "18:00",
                endTime: "19:30",
                type: "Figure Skating"
            },
            {
                facility: "Hillcrest Centre",
                city: "Vancouver",
                address: "4575 Clancy Loranger Way, Vancouver",
                lat: 49.2438,
                lng: -123.1090,
                date: "2026-01-22",
                startTime: "15:00",
                endTime: "16:30",
                type: "Public Skating"
            },
            {
                facility: "Bill Copeland Sports Centre",
                city: "Burnaby",
                address: "3676 Kensington Ave, Burnaby",
                lat: 49.2389,
                lng: -123.0042,
                date: "2026-01-23",
                startTime: "19:00",
                endTime: "20:30",
                type: "Family Hockey"
            },
            {
                facility: "Kensington Arena",
                city: "Burnaby",
                address: "6050 McMurray Ave, Burnaby",
                lat: 49.2267,
                lng: -123.0036,
                date: "2026-01-24",
                startTime: "11:00",
                endTime: "12:30",
                type: "Family Skate"
            }
        ];

        let allSessions = [];
        let filteredSessions = [];
        let userLocation = null;
        // Default to tomorrow if it's past 9pm
        let currentDate = new Date();
        if (currentDate.getHours() >= 21) {
            currentDate.setDate(currentDate.getDate() + 1);
        }
        let viewMode = 'day';
        let isLoading = false; // 'day', 'week', or 'month'

        const sportFilter = document.getElementById('sportFilter');
        const cityFilter = document.getElementById('cityFilter');
        const facilityFilter = document.getElementById('facilityFilter');
        const activityFiltersContainer = document.getElementById('activityFilters');
        const postalCodeInput = document.getElementById('postalCode');
        const distanceFilter = document.getElementById('distanceFilter');
        const calendar = document.getElementById('calendar');
        const currentMonthEl = document.getElementById('currentMonth');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const dayViewBtn = document.getElementById('dayViewBtn');
        const weekViewBtn = document.getElementById('weekViewBtn');
        const monthViewBtn = document.getElementById('monthViewBtn');
        const modal = document.getElementById('sessionModal');
        const modalClose = document.getElementById('modalClose');
        const useLocationBtn = document.getElementById('useLocationBtn');
        const facilityMapBtn = document.getElementById('facilityMapBtn');
        const viewMapBtn = document.getElementById('viewMapBtn');
        const mapModal = document.getElementById('mapModal');
        const mapModalClose = document.getElementById('mapModalClose');
        let facilityMap = null;
        let distanceCircle = null;

        // Dynamic daily schedule loading
        const loadedDays = new Map(); // Cache: dateStr -> sessions array
        let scheduleIndex = null; // Metadata from index.json
        const SCHEDULES_BASE = './data/schedules';

        // Get cache buster that changes hourly
        function getCacheBuster() {
            return Math.floor(Date.now() / 3600000);
        }

        // Load the index.json with metadata
        async function loadScheduleIndex() {
            const response = await fetch(`${SCHEDULES_BASE}/index.json?v=${getCacheBuster()}`);
            if (!response.ok) throw new Error(`Failed to load index: ${response.status}`);
            return await response.json();
        }

        // Load a single day's schedule
        async function loadDay(dateStr) {
            if (loadedDays.has(dateStr)) {
                return loadedDays.get(dateStr);
            }

            const [year, month, day] = dateStr.split('-');
            const url = `${SCHEDULES_BASE}/${year}/${month}/${day}.json?v=${getCacheBuster()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    // Day might not exist (no sessions), return empty
                    loadedDays.set(dateStr, []);
                    return [];
                }
                const data = await response.json();
                const sessions = data.sessions || [];
                loadedDays.set(dateStr, sessions);
                return sessions;
            } catch (e) {
                console.warn(`Could not load ${dateStr}:`, e);
                loadedDays.set(dateStr, []);
                return [];
            }
        }

        // Load multiple days in parallel
        async function loadDays(dateStrings) {
            const promises = dateStrings.map(d => loadDay(d));
            await Promise.all(promises);
        }

        // Get dates needed for current view
        function getDatesForView() {
            const dates = [];
            if (viewMode === 'day') {
                // Just the current day
                dates.push(formatDateStr(currentDate));
            } else if (viewMode === 'week') {
                // 7 days of the week
                const startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                for (let i = 0; i < 7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);
                    dates.push(formatDateStr(d));
                }
            } else {
                // Month view: up to 42 days (6 weeks grid)
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();

                // Previous month days
                for (let i = firstDay - 1; i >= 0; i--) {
                    const d = new Date(year, month - 1, daysInPrevMonth - i);
                    dates.push(formatDateStr(d));
                }
                // Current month days
                for (let day = 1; day <= daysInMonth; day++) {
                    dates.push(formatDateStr(new Date(year, month, day)));
                }
                // Next month days
                const remaining = 42 - dates.length;
                for (let day = 1; day <= remaining; day++) {
                    dates.push(formatDateStr(new Date(year, month + 1, day)));
                }
            }
            return dates;
        }

        function formatDateStr(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getRelativeTimeString(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            if (diffDays === 1) return 'yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }

        // Rebuild allSessions from loaded days
        function rebuildAllSessions() {
            allSessions = [];
            for (const [dateStr, sessions] of loadedDays) {
                allSessions.push(...sessions);
            }
        }

        // Update data source counts in the info box
        function updateDataSourceCounts() {
            const cityCounts = {};
            for (const session of allSessions) {
                // Map outdoor rinks to "Outdoor" category
                const isOutdoor = session.facility.includes('Robson Square') ||
                                  session.facility.includes('Shipyards');
                const city = isOutdoor ? 'Outdoor' : session.city;
                cityCounts[city] = (cityCounts[city] || 0) + 1;
            }

            // Update each data source item
            document.querySelectorAll('.data-source-item').forEach(item => {
                const city = item.dataset.city;
                const countEl = item.querySelector('.data-source-count');
                if (countEl && city) {
                    const count = cityCounts[city] || 0;
                    countEl.textContent = count > 0 ? `(${count})` : '';
                }
            });
        }

        // Fetch schedule data - now loads dynamically
        async function fetchRealData() {
            if (USE_SAMPLE_DATA) {
                allSessions = [...sampleSessions];
                filteredSessions = [...sampleSessions];
                initializeFilters();
                renderCalendar();
                return;
            }

            try {
                isLoading = true;
                renderLoading();

                // Load index first
                scheduleIndex = await loadScheduleIndex();

                // Update status in info box
                const statusEl = document.getElementById('scheduleStatus');
                if (statusEl && scheduleIndex.lastUpdated) {
                    const updateDate = new Date(scheduleIndex.lastUpdated);
                    const relativeTime = getRelativeTimeString(updateDate);
                    statusEl.innerHTML = `
                        <strong>${scheduleIndex.totalSessions} sessions</strong> from ${scheduleIndex.dateRange.start} to ${scheduleIndex.dateRange.end}.<br>
                        Last updated: ${relativeTime}
                    `;
                }

                // Load days for current view
                const datesToLoad = getDatesForView();
                await loadDays(datesToLoad);

                rebuildAllSessions();
                isLoading = false;

                updateDataSourceCounts();
                initializeFilters();
                filterSessions();
            } catch (error) {
                console.error('Error fetching data:', error);
                isLoading = false;

                // Fall back to sample data
                allSessions = [...sampleSessions];
                filteredSessions = [...sampleSessions];

                const statusEl = document.getElementById('scheduleStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <strong style="color: #e74c3c;">Could not load live data</strong><br>
                        Showing sample sessions instead. Error: ${error.message}
                    `;
                }

                initializeFilters();
                renderCalendar();
            }
        }

        // Load data for view when navigating
        async function loadDataForView() {
            const datesToLoad = getDatesForView();
            const newDates = datesToLoad.filter(d => !loadedDays.has(d));

            if (newDates.length > 0) {
                await loadDays(newDates);
                rebuildAllSessions();
                updateDataSourceCounts();
                initializeFilters();
            }
            filterSessions();
        }

        function renderLoading() {
            const calendar = document.getElementById('calendar');
            calendar.className = 'calendar-grid day-view';
            calendar.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚õ∏Ô∏è</div>
                    <div style="font-size: 1.2rem; color: #667eea; font-weight: 600; margin-bottom: 10px;">
                        Loading skating sessions...
                    </div>
                    <div style="color: #666;">
                        Fetching data from Vancouver and Burnaby recreation centers
                    </div>
                </div>
            `;
        }

        function initializeFilters() {
            const facilities = [...new Set(allSessions.map(s => s.facility))].sort();
            facilityFilter.innerHTML = '<option value="all">All Facilities</option>';
            facilities.forEach(f => {
                const option = document.createElement('option');
                option.value = f;
                option.textContent = f;
                facilityFilter.appendChild(option);
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function geocodePostalCode(postalCode) {
            const cleanedCode = postalCode.replace(/\s/g, '').toUpperCase();
            if (cleanedCode.length < 6) return null;

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?postalcode=${cleanedCode}&country=Canada&format=json&limit=1`
                );
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        async function handlePostalCodeChange() {
            const postalCode = postalCodeInput.value.trim();
            if (!postalCode) {
                userLocation = null;
                filterSessions();
                return;
            }

            const coords = await geocodePostalCode(postalCode);
            if (coords) {
                userLocation = coords;
                filterSessions();
            } else {
                userLocation = null;
                filterSessions();
            }
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`
                );
                const data = await response.json();
                if (data && data.address && data.address.postcode) {
                    return data.address.postcode;
                }
            } catch (error) {
                console.error('Reverse geocoding error:', error);
            }
            return null;
        }

        async function useCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            useLocationBtn.textContent = 'üìç Getting location...';
            useLocationBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    userLocation = { lat, lng };
                    
                    const postalCode = await reverseGeocode(lat, lng);
                    if (postalCode) {
                        postalCodeInput.value = postalCode;
                    }
                    
                    filterSessions();
                    useLocationBtn.textContent = 'üìç Use My Location';
                    useLocationBtn.disabled = false;
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    alert('Unable to get your location. Please enter your postal code manually.');
                    useLocationBtn.textContent = 'üìç Use My Location';
                    useLocationBtn.disabled = false;
                }
            );
        }

        function getSelectedActivityTypes() {
            // Get fresh checkbox elements from DOM
            const checkboxes = activityFiltersContainer.querySelectorAll('input[type="checkbox"]:not([data-all="true"])');
            return Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }

        function filterSessions() {
            const selectedTypes = getSelectedActivityTypes();
            const showDiscount = selectedTypes.includes('__discount__');
            const showPublic = selectedTypes.includes('Public Skating');
            const regularTypes = selectedTypes.filter(t => t !== '__discount__');

            filteredSessions = allSessions.filter(session => {
                const cityMatch = cityFilter.value === 'all' || session.city === cityFilter.value;
                const facilityMatch = facilityFilter.value === 'all' || session.facility === facilityFilter.value;

                // Check if this is a discount/free session
                const actName = (session.activityName || '').toLowerCase();
                const isDiscount = actName.includes('toonie') ||
                                  actName.includes('discount') ||
                                  actName.includes('free') ||
                                  actName.includes('loonie') ||
                                  actName.includes('$2');

                // Activity type matching
                let activityMatch = false;

                // Discount sessions only shown if Discount filter is checked
                if (isDiscount && session.type === 'Public Skating') {
                    activityMatch = showDiscount;
                } else if (session.type === 'Public Skating') {
                    // Regular public skating (non-discount)
                    activityMatch = showPublic;
                } else {
                    // Other types
                    activityMatch = regularTypes.includes(session.type);
                }

                let distanceMatch = true;
                if (userLocation && distanceFilter.value !== '999') {
                    const distance = calculateDistance(
                        userLocation.lat,
                        userLocation.lng,
                        session.lat,
                        session.lng
                    );
                    distanceMatch = distance <= parseFloat(distanceFilter.value);
                }

                return cityMatch && facilityMatch && distanceMatch && activityMatch;
            });

            renderCalendar();
        }

        function formatTime(time) {
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const displayHour = h % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function shortFacilityName(facility) {
            // Map long facility names to shorter versions for compact display
            const shortNames = {
                'Hillcrest Centre': 'Hillcrest',
                'Kerrisdale Cyclone Taylor Arena': 'Kerrisdale',
                'Killarney Rink': 'Killarney',
                'Kitsilano Rink': 'Kitsilano',
                'Sunset Rink': 'Sunset',
                'Trout Lake Rink': 'Trout Lake',
                'West End Community Centre': 'West End',
                'Kensington Complex': 'Kensington',
                'Rosemary Brown Recreation Centre': 'Rosemary Brown',
                'Bill Copeland Sports Centre': 'Bill Copeland',
                'Burnaby Lake Arena': 'Burnaby Lake',
                'Karen Magnussen Community Centre': 'Karen Magnussen',
                'Harry Jerome Community Recreation Centre': 'Harry Jerome',
                'Canlan Ice Sports North Shore': 'Canlan',
                'West Vancouver Community Centre': 'West Van CC',
                'Robson Square Ice Rink': 'Robson Square',
                'Shipyards Skate Plaza': 'Shipyards',
                "Queen's Park Arena": "Queen's Park",
                'Moody Park Arena': 'Moody Park',
            };
            return shortNames[facility] || facility.split(' ').slice(0, 2).join(' ');
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours === 0) return `${mins}min`;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}min`;
        }

        function calculateDuration(startTime, endTime) {
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            return (endH * 60 + endM) - (startH * 60 + startM);
        }

        function getRelativeTime(dateStr, timeStr) {
            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            if (dateStr !== todayStr) return null;

            const [hours, minutes] = timeStr.split(':').map(Number);
            const sessionTime = new Date(now);
            sessionTime.setHours(hours, minutes, 0, 0);

            const diffMs = sessionTime - now;
            const diffMins = Math.round(diffMs / 60000);

            if (diffMins < -60) {
                const hoursAgo = Math.round(-diffMins / 60);
                return `${hoursAgo}h ago`;
            } else if (diffMins < 0) {
                return `${-diffMins}min ago`;
            } else if (diffMins === 0) {
                return 'now';
            } else if (diffMins < 60) {
                return `in ${diffMins}min`;
            } else {
                const hoursFromNow = Math.round(diffMins / 60);
                return `in ${hoursFromNow}h`;
            }
        }

        function isDiscountSession(session) {
            const actName = (session.activityName || '').toLowerCase();
            return actName.includes('toonie') ||
                   actName.includes('discount') ||
                   actName.includes('free') ||
                   actName.includes('loonie') ||
                   actName.includes('$2');
        }

        function getSessionClass(session) {
            // Check for discount/free sessions first
            if (isDiscountSession(session)) return 'discount';

            const type = typeof session === 'string' ? session : session.type;
            if (type === 'Public Skating') return 'public';
            if (type === 'Family Skate') return 'family';
            if (type === 'Family Hockey') return 'hockey';
            if (type === 'Figure Skating') return 'figure';
            return 'public';
        }

        function renderCalendar() {
            if (viewMode === 'day') {
                renderDayView();
            } else if (viewMode === 'week') {
                renderWeekView();
            } else {
                renderMonthView();
            }
        }

        function renderDayView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const day = currentDate.getDate();
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            const dayOfWeek = dayNames[currentDate.getDay()];

            currentMonthEl.textContent = `${dayOfWeek}, ${monthNames[month]} ${day}, ${year}`;

            calendar.className = 'calendar-grid day-view';

            const daySessions = filteredSessions.filter(s => s.date === dateStr)
                .sort((a, b) => {
                    // Primary sort by time
                    const timeCompare = a.startTime.localeCompare(b.startTime);
                    if (timeCompare !== 0) return timeCompare;
                    // Secondary sort by distance (closer first) when location available
                    if (userLocation) {
                        const distA = calculateDistance(userLocation.lat, userLocation.lng, a.lat, a.lng);
                        const distB = calculateDistance(userLocation.lat, userLocation.lng, b.lat, b.lng);
                        return distA - distB;
                    }
                    return 0;
                });

            // Build day view with date picker and timeline
            const today = new Date();
            const todayDateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const shortDayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            // Generate 8 days: yesterday + today + next 6 days
            let dayButtonsHtml = '';
            for (let offset = -1; offset <= 6; offset++) {
                const btnDate = new Date(currentDate);
                btnDate.setDate(currentDate.getDate() + offset);
                const btnDateStr = `${btnDate.getFullYear()}-${String(btnDate.getMonth() + 1).padStart(2, '0')}-${String(btnDate.getDate()).padStart(2, '0')}`;
                const btnTodayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                const isSelected = offset === 0;
                const isTodayBtn = btnDateStr === btnTodayStr;
                const isWeekend = btnDate.getDay() === 0 || btnDate.getDay() === 6;
                const classes = [isSelected ? 'selected' : '', isTodayBtn ? 'is-today' : '', isWeekend ? 'is-weekend' : ''].filter(Boolean).join(' ');

                dayButtonsHtml += `
                    <button class="${classes}" onclick="goToDate('${btnDateStr}')">
                        <span class="day-name">${shortDayNames[btnDate.getDay()]}</span>
                        <span class="day-num">${btnDate.getDate()}</span>
                    </button>
                `;
            }

            let html = `
                <div class="day-view-header">
                    <div class="day-picker">
                        <div class="day-picker-nav">
                            <button class="nav-btn" onclick="changeDay(-7)" title="Previous week">¬´¬´</button>
                            <button class="nav-btn" onclick="changeDay(-1)" title="Previous day">‚Äπ</button>
                        </div>
                        <div class="day-picker-days">
                            ${dayButtonsHtml}
                        </div>
                        <div class="day-picker-nav">
                            <button class="nav-btn" onclick="changeDay(1)" title="Next day">‚Ä∫</button>
                            <button class="nav-btn" onclick="changeDay(7)" title="Next week">¬ª¬ª</button>
                        </div>
                        <input type="date" id="datePicker" value="${dateStr}" onchange="goToDate(this.value)" title="Pick a date">
                    </div>
                </div>
            `;

            if (daySessions.length === 0) {
                html += `
                    <div class="no-sessions-message">
                        <div class="icon">‚õ∏Ô∏è</div>
                        <div>No sessions scheduled for this day</div>
                        <div style="margin-top: 10px; font-size: 0.9rem;">Try selecting different filters or another date</div>
                    </div>
                `;
            } else {
                // Find time range for this day's sessions
                const startHour = Math.max(6, Math.min(...daySessions.map(s => parseInt(s.startTime.split(':')[0]))) - 1);
                const endHour = Math.min(23, Math.max(...daySessions.map(s => parseInt(s.endTime.split(':')[0]))) + 1);

                html += `<div class="timeline-container">`;
                html += `<div class="timeline-hours">`;
                for (let h = startHour; h <= endHour; h++) {
                    const displayHour = h % 12 || 12;
                    const ampm = h >= 12 ? 'PM' : 'AM';
                    html += `<div class="timeline-hour">${displayHour}:00 ${ampm}</div>`;
                }
                html += `</div>`;

                html += `<div class="timeline-grid">`;
                for (let h = startHour; h <= endHour; h++) {
                    html += `<div class="timeline-hour-line"></div>`;
                }

                // Check if this is today
                const now = new Date();
                const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const currentMinutes = isToday ? (now.getHours() - startHour) * 60 + now.getMinutes() : -1;

                // Calculate columns for overlapping events
                const events = daySessions.map(session => {
                    const [startH, startM] = session.startTime.split(':').map(Number);
                    const [endH, endM] = session.endTime.split(':').map(Number);
                    return {
                        session,
                        start: startH * 60 + startM,
                        end: endH * 60 + endM,
                        column: 0,
                        totalColumns: 1
                    };
                });

                // Assign columns to overlapping events
                for (let i = 0; i < events.length; i++) {
                    const event = events[i];
                    // Find overlapping events that come before this one
                    const overlapping = events.slice(0, i).filter(e =>
                        e.end > event.start && e.start < event.end
                    );
                    // Find first available column
                    const usedColumns = overlapping.map(e => e.column);
                    let col = 0;
                    while (usedColumns.includes(col)) col++;
                    event.column = col;
                }

                // Calculate total columns for each event group
                for (let i = 0; i < events.length; i++) {
                    const event = events[i];
                    const overlapping = events.filter(e =>
                        e.end > event.start && e.start < event.end
                    );
                    const maxCol = Math.max(...overlapping.map(e => e.column)) + 1;
                    overlapping.forEach(e => e.totalColumns = Math.max(e.totalColumns, maxCol));
                }

                // Render sessions as positioned blocks
                events.forEach(({ session, start, end, column, totalColumns }) => {
                    const startMinutes = start - startHour * 60;
                    const durationMins = end - start;
                    const durationStr = formatDuration(durationMins);
                    const relativeTime = getRelativeTime(dateStr, session.startTime);
                    const relativeStr = relativeTime ? ` - ${relativeTime}` : '';

                    const top = startMinutes; // 1px per minute
                    const height = Math.max(durationMins, 55); // minimum 55px to fit time, name, location

                    // Calculate horizontal position based on column
                    const width = (100 / totalColumns) - 1;
                    const left = column * (100 / totalColumns);

                    const sessionClass = getSessionClass(session);
                    const activityName = session.activityName || session.type;

                    // Check if session has ended (for past styling)
                    const [endH, endM] = session.endTime.split(':').map(Number);
                    const isPast = isToday && (endH * 60 + endM) < (now.getHours() * 60 + now.getMinutes());
                    const pastClass = isPast ? ' past' : '';

                    html += `
                        <div class="timeline-event ${sessionClass}${pastClass}"
                             style="top: ${top}px; height: ${height}px; left: ${left}%; width: ${width}%;"
                             onclick='showSessionDetails(${JSON.stringify(session).replace(/'/g, "&apos;")})'>
                            <div class="timeline-event-time">${formatTime(session.startTime)} - ${formatTime(session.endTime)}</div>
                            <div class="timeline-event-name">${activityName}</div>
                            <div class="timeline-event-location">${session.facility}</div>
                        </div>
                    `;
                });

                // Add "now" line if it's today and current time is within the displayed range
                if (isToday && currentMinutes >= 0 && currentMinutes <= (endHour - startHour + 1) * 60) {
                    html += `<div class="timeline-now-line" style="top: ${currentMinutes}px;"></div>`;
                }

                html += `</div></div>`;
            }

            calendar.innerHTML = html;
        }

        function renderWeekView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Get start of week (Sunday)
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            currentMonthEl.textContent = `${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()} - ${monthNames[endOfWeek.getMonth()]} ${endOfWeek.getDate()}, ${year}`;

            calendar.className = 'calendar-grid week-view';

            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let html = dayNames.map(d => `<div class="calendar-day-header">${d}</div>`).join('');

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + i);
                const dateStr = `${dayDate.getFullYear()}-${String(dayDate.getMonth() + 1).padStart(2, '0')}-${String(dayDate.getDate()).padStart(2, '0')}`;
                const daySessions = filteredSessions.filter(s => s.date === dateStr)
                    .sort((a, b) => {
                        const timeCompare = a.startTime.localeCompare(b.startTime);
                        if (timeCompare !== 0) return timeCompare;
                        if (userLocation) {
                            const distA = calculateDistance(userLocation.lat, userLocation.lng, a.lat, a.lng);
                            const distB = calculateDistance(userLocation.lat, userLocation.lng, b.lat, b.lng);
                            return distA - distB;
                        }
                        return 0;
                    });

                const isToday = dateStr === todayStr;
                const isOtherMonth = dayDate.getMonth() !== month;

                let sessionsHTML = '';
                if (daySessions.length > 0) {
                    sessionsHTML = '<div class="day-sessions">';
                    daySessions.slice(0, 4).forEach(session => {
                        const activityName = session.activityName || session.type;
                        sessionsHTML += `<div class="session-pill ${getSessionClass(session)}" onclick='showSessionDetails(${JSON.stringify(session).replace(/'/g, "&apos;")})'>${formatTime(session.startTime)} ${shortFacilityName(session.facility)}</div>`;
                    });
                    if (daySessions.length > 4) {
                        sessionsHTML += `<div class="session-pill" style="background: #f5f5f5; color: #666; cursor: default;">+${daySessions.length - 4} more</div>`;
                    }
                    sessionsHTML += '</div>';
                }

                html += `<div class="calendar-day${isToday ? ' today' : ''}${isOtherMonth ? ' other-month' : ''}" onclick="goToDateView('${dateStr}')">
                    <div class="day-number">${dayDate.getDate()}</div>
                    ${sessionsHTML}
                </div>`;
            }

            calendar.innerHTML = html;
        }

        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            currentMonthEl.textContent = `${monthNames[month]} ${year}`;

            calendar.className = 'calendar-grid';

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            let html = `
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
            `;

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const daySessions = filteredSessions.filter(s => s.date === dateStr);
                const isToday = dateStr === todayStr;

                let sessionsHTML = '';
                if (daySessions.length > 0) {
                    sessionsHTML = '<div class="day-sessions">';
                    daySessions.slice(0, 3).forEach(session => {
                        sessionsHTML += `<div class="session-pill ${getSessionClass(session)}" onclick='event.stopPropagation(); showSessionDetails(${JSON.stringify(session).replace(/'/g, "&apos;")})'>${formatTime(session.startTime)} ${session.facility.split(' ')[0]}</div>`;
                    });
                    if (daySessions.length > 3) {
                        sessionsHTML += `<div class="session-pill" style="background: #f5f5f5; color: #666; cursor: default;">+${daySessions.length - 3} more</div>`;
                    }
                    sessionsHTML += '</div>';
                }

                html += `<div class="calendar-day${isToday ? ' today' : ''}" onclick="goToDateView('${dateStr}')">
                    <div class="day-number">${day}</div>
                    ${sessionsHTML}
                </div>`;
            }

            const remainingDays = 42 - (firstDay + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }

            calendar.innerHTML = html;
        }

        // Day navigation functions
        async function changeDay(delta) {
            currentDate.setDate(currentDate.getDate() + delta);
            await loadDataForView();
        }

        async function goToDate(dateStr) {
            currentDate = new Date(dateStr + 'T00:00:00');
            await loadDataForView();
        }

        async function goToToday() {
            currentDate = new Date();
            await loadDataForView();
        }

        async function goToDateView(dateStr) {
            currentDate = new Date(dateStr + 'T00:00:00');
            viewMode = 'day';
            updateViewButtons();
            await loadDataForView();
        }

        function updateViewButtons() {
            dayViewBtn.classList.toggle('active', viewMode === 'day');
            weekViewBtn.classList.toggle('active', viewMode === 'week');
            monthViewBtn.classList.toggle('active', viewMode === 'month');
        }

        window.changeDay = changeDay;
        window.goToDate = goToDate;
        window.goToToday = goToToday;
        window.goToDateView = goToDateView;

        function showSessionDetails(session) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            const activityName = session.activityName || session.type;
            modalTitle.textContent = activityName;

            const durationMins = calculateDuration(session.startTime, session.endTime);
            const durationStr = formatDuration(durationMins);
            const relativeTime = getRelativeTime(session.date, session.startTime);
            const relativeStr = relativeTime ? ` (${relativeTime})` : '';

            let distanceHTML = '';
            if (userLocation) {
                const distance = calculateDistance(
                    userLocation.lat,
                    userLocation.lng,
                    session.lat,
                    session.lng
                );
                distanceHTML = `<div class="session-detail"><strong>Distance:</strong>${distance.toFixed(1)} km away</div>`;
            }

            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(session.address || session.facility + ', ' + session.city)}`;

            const ageRangeHTML = session.ageRange ? `<div class="session-detail"><strong>Age Range:</strong>${session.ageRange}</div>` : '';
            const descriptionHTML = session.description ? `<div class="session-detail"><strong>Description:</strong>${session.description}</div>` : '';
            const reserveButtonHTML = session.activityUrl ? `<a href="${session.activityUrl}" target="_blank" class="add-to-calendar" style="display: block; text-align: center; text-decoration: none; margin-top: 10px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">Reserve / Register</a>` : '';

            modalBody.innerHTML = `
                <div class="session-detail">
                    <strong>Activity:</strong>
                    ${activityName}
                </div>
                <div class="session-detail">
                    <strong>Type:</strong>
                    ${session.type}
                </div>
                ${ageRangeHTML}
                <div class="session-detail">
                    <strong>Date:</strong>
                    ${new Date(session.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}${relativeStr}
                </div>
                <div class="session-detail">
                    <strong>Time:</strong>
                    ${formatTime(session.startTime)} - ${formatTime(session.endTime)} (${durationStr})
                </div>
                <div class="session-detail">
                    <strong>Location:</strong>
                    <a href="${mapsUrl}" target="_blank" style="color: #667eea;">${session.facility}</a>
                </div>
                <div class="session-detail">
                    <strong>Address:</strong>
                    ${session.address}, ${session.city}
                </div>
                ${distanceHTML}
                ${descriptionHTML}
                ${reserveButtonHTML}
                <button class="add-to-calendar" onclick='addToGoogleCalendar(${JSON.stringify(session).replace(/'/g, "&apos;")})'>
                    üìÖ Add to Google Calendar
                </button>
            `;
            
            modal.classList.add('active');
        }

        function addToGoogleCalendar(session) {
            const startDateTime = `${session.date}T${session.startTime}:00`;
            const endDateTime = `${session.date}T${session.endTime}:00`;
            
            const title = encodeURIComponent(`${session.type} - ${session.facility}`);
            const details = encodeURIComponent(`${session.type} at ${session.facility}`);
            const location = encodeURIComponent(session.address);
            const start = startDateTime.replace(/[-:]/g, '');
            const end = endDateTime.replace(/[-:]/g, '');

            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&location=${location}&dates=${start}/${end}`;
            window.open(url, '_blank');
        }

        // View toggle buttons
        dayViewBtn.addEventListener('click', async () => {
            viewMode = 'day';
            updateViewButtons();
            await loadDataForView();
        });

        weekViewBtn.addEventListener('click', async () => {
            viewMode = 'week';
            updateViewButtons();
            await loadDataForView();
        });

        monthViewBtn.addEventListener('click', async () => {
            viewMode = 'month';
            updateViewButtons();
            await loadDataForView();
        });

        // Navigation buttons - behavior depends on view mode
        prevBtn.addEventListener('click', async () => {
            if (viewMode === 'day') {
                currentDate.setDate(currentDate.getDate() - 1);
            } else if (viewMode === 'week') {
                currentDate.setDate(currentDate.getDate() - 7);
            } else {
                currentDate.setMonth(currentDate.getMonth() - 1);
            }
            await loadDataForView();
        });

        nextBtn.addEventListener('click', async () => {
            if (viewMode === 'day') {
                currentDate.setDate(currentDate.getDate() + 1);
            } else if (viewMode === 'week') {
                currentDate.setDate(currentDate.getDate() + 7);
            } else {
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            await loadDataForView();
        });

        modalClose.addEventListener('click', () => {
            modal.classList.remove('active');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });

        facilityMapBtn.addEventListener('click', () => {
            const selectedFacility = facilityFilter.value;
            if (selectedFacility !== 'all') {
                // Find the facility's address from allSessions
                const facilitySession = allSessions.find(s => s.facility === selectedFacility);
                if (facilitySession) {
                    const query = encodeURIComponent(facilitySession.address || selectedFacility + ', ' + facilitySession.city);
                    window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
                }
            }
        });

        // Update activity checkboxes when sport changes
        function updateActivityFilters() {
            const config = SPORTS_CONFIG[currentSport];
            if (!config) return;

            let html = '<span class="activity-label">Activity Types:</span>';
            config.activityTypes.forEach(type => {
                const extraClass = type.isAll ? ' all-toggle' : '';
                html += `
                    <label class="activity-checkbox${extraClass}">
                        <input type="checkbox" id="${type.id}" value="${type.value}" ${type.checked ? 'checked' : ''} ${type.isAll ? 'data-all="true"' : ''}>
                        <span>${type.label}</span>
                    </label>
                `;
            });
            activityFiltersContainer.innerHTML = html;

            // Re-attach event listeners with "All" toggle logic
            const allCheckbox = activityFiltersContainer.querySelector('input[data-all="true"]');
            const otherCheckboxes = activityFiltersContainer.querySelectorAll('input:not([data-all="true"])');

            if (allCheckbox) {
                allCheckbox.addEventListener('change', () => {
                    otherCheckboxes.forEach(cb => {
                        cb.checked = allCheckbox.checked;
                    });
                    filterSessions();
                });
            }

            otherCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    // Update "All" checkbox state
                    if (allCheckbox) {
                        const allChecked = Array.from(otherCheckboxes).every(c => c.checked);
                        allCheckbox.checked = allChecked;
                    }
                    filterSessions();
                });
            });
        }

        // Handle sport change
        function updateSportTheme() {
            // Remove all sport classes
            document.body.classList.remove('sport-skating', 'sport-swimming');
            // Add current sport class
            document.body.classList.add(`sport-${currentSport}`);
        }

        sportFilter.addEventListener('change', () => {
            currentSport = sportFilter.value;
            updateSportTheme();
            updateActivityFilters();
            fetchRealData();
        });

        let postalCodeTimeout;
        postalCodeInput.addEventListener('input', () => {
            clearTimeout(postalCodeTimeout);
            postalCodeTimeout = setTimeout(handlePostalCodeChange, 1000);
        });

        useLocationBtn.addEventListener('click', useCurrentLocation);

        window.showSessionDetails = showSessionDetails;
        window.addToGoogleCalendar = addToGoogleCalendar;

        // localStorage settings persistence
        const STORAGE_KEY = 'skatingScheduleSettings';

        function saveSettings() {
            const settings = {
                postalCode: postalCodeInput.value,
                userLocation: userLocation,
                city: cityFilter.value,
                facility: facilityFilter.value,
                distance: distanceFilter.value,
                viewMode: viewMode,
                activityTypes: getSelectedActivityTypes()
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            } catch (e) {
                console.warn('Could not save settings:', e);
            }
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return null;
                return JSON.parse(saved);
            } catch (e) {
                console.warn('Could not load settings:', e);
                return null;
            }
        }

        function applySettings(settings) {
            if (!settings) return;

            // Apply location
            if (settings.postalCode) {
                postalCodeInput.value = settings.postalCode;
            }
            if (settings.userLocation) {
                userLocation = settings.userLocation;
            }

            // Apply filters
            if (settings.city) {
                cityFilter.value = settings.city;
            }
            if (settings.distance) {
                distanceFilter.value = settings.distance;
            }
            if (settings.viewMode) {
                viewMode = settings.viewMode;
                updateViewButtons();
            }

            // Activity types will be applied after data loads
            if (settings.activityTypes) {
                window._savedActivityTypes = settings.activityTypes;
            }
        }

        function applySavedActivityTypes() {
            const saved = window._savedActivityTypes;
            if (!saved) return;

            const checkboxes = activityFiltersContainer.querySelectorAll('input[type="checkbox"]:not([data-all="true"])');
            checkboxes.forEach(cb => {
                cb.checked = saved.includes(cb.value);
            });

            // Update "All" checkbox
            const allCheckbox = activityFiltersContainer.querySelector('input[data-all="true"]');
            if (allCheckbox) {
                const otherCheckboxes = activityFiltersContainer.querySelectorAll('input:not([data-all="true"])');
                allCheckbox.checked = Array.from(otherCheckboxes).every(c => c.checked);
            }
        }

        // Save settings when filters change
        cityFilter.addEventListener('change', () => { filterSessions(); saveSettings(); });
        distanceFilter.addEventListener('change', () => { filterSessions(); saveSettings(); });

        // Override facility filter listener to also save
        facilityFilter.removeEventListener('change', filterSessions);
        facilityFilter.addEventListener('change', () => {
            const selectedFacility = facilityFilter.value;
            facilityMapBtn.disabled = selectedFacility === 'all';
            filterSessions();
            saveSettings();
        });

        // Save on view mode change
        const originalDayClick = dayViewBtn.onclick;
        dayViewBtn.addEventListener('click', saveSettings);
        weekViewBtn.addEventListener('click', saveSettings);
        monthViewBtn.addEventListener('click', saveSettings);

        // Save after postal code change
        const originalHandlePostalCode = handlePostalCodeChange;
        handlePostalCodeChange = async function() {
            await originalHandlePostalCode.call(this);
            saveSettings();
        };

        // Save after geolocation
        const originalUseCurrentLocation = useCurrentLocation;
        useCurrentLocation = async function() {
            await originalUseCurrentLocation.call(this);
            saveSettings();
        };

        // Wrap updateActivityFilters to apply saved types and add save listeners
        const originalUpdateActivityFilters = updateActivityFilters;
        updateActivityFilters = function() {
            originalUpdateActivityFilters();
            applySavedActivityTypes();

            // Add save listeners to new checkboxes
            const checkboxes = activityFiltersContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', saveSettings);
            });
        };

        // Apply facility filter after data loads (needs facility list populated)
        const originalFetchRealData = fetchRealData;
        fetchRealData = async function() {
            await originalFetchRealData();
            const saved = loadSettings();
            if (saved?.facility) {
                facilityFilter.value = saved.facility;
                facilityMapBtn.disabled = saved.facility === 'all';
                filterSessions();
            }
        };

        // Map functionality
        function initMap() {
            if (facilityMap) {
                facilityMap.remove();
            }

            // Center on Metro Vancouver
            facilityMap = L.map('facilityMap').setView([49.25, -123.1], 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(facilityMap);

            // Update map title with session count
            const mapTitle = document.getElementById('mapTitle');
            mapTitle.textContent = `${filteredSessions.length} Sessions at ${new Set(filteredSessions.map(s => s.facility)).size} Facilities`;

            // Group filtered sessions by facility (respects current filters)
            const facilitySessions = {};
            filteredSessions.forEach(session => {
                const key = `${session.facility}-${session.lat}-${session.lng}`;
                if (!facilitySessions[key]) {
                    facilitySessions[key] = {
                        facility: session.facility,
                        city: session.city,
                        address: session.address,
                        lat: session.lat,
                        lng: session.lng,
                        sessions: []
                    };
                }
                facilitySessions[key].sessions.push(session);
            });

            // Color markers by city
            const cityColors = {
                'Vancouver': '#1976d2',
                'Burnaby': '#7b1fa2',
                'North Vancouver': '#388e3c',
                'West Vancouver': '#00796b',
                'New Westminster': '#c2185b'
            };

            // Add markers for each facility
            const markers = [];
            Object.values(facilitySessions).forEach(facility => {
                // Check if it's an outdoor rink
                const isOutdoor = facility.facility.includes('Robson Square') ||
                                  facility.facility.includes('Shipyards');
                const color = isOutdoor ? '#ef6c00' : (cityColors[facility.city] || '#666');

                const markerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background: ${color};
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">${facility.sessions.length}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([facility.lat, facility.lng], { icon: markerIcon });

                // Create popup content
                const upcomingSessions = facility.sessions
                    .sort((a, b) => a.date.localeCompare(b.date) || a.startTime.localeCompare(b.startTime))
                    .slice(0, 5);

                let popupContent = `
                    <div style="min-width: 200px;">
                        <strong style="font-size: 14px;">${facility.facility}</strong><br>
                        <span style="color: #666; font-size: 12px;">${facility.address}</span><br>
                        <span style="color: ${color}; font-weight: 600;">${facility.sessions.length} upcoming sessions</span>
                        <hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">
                `;

                upcomingSessions.forEach(session => {
                    const dateObj = new Date(session.date + 'T00:00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    popupContent += `
                        <div style="margin-bottom: 6px; font-size: 12px;">
                            <strong>${dateStr}</strong> ${formatTime(session.startTime)}-${formatTime(session.endTime)}<br>
                            <span style="color: #555;">${session.activityName || session.type}</span>
                        </div>
                    `;
                });

                if (facility.sessions.length > 5) {
                    popupContent += `<div style="color: #667eea; font-size: 11px;">+${facility.sessions.length - 5} more sessions</div>`;
                }

                popupContent += '</div>';
                marker.bindPopup(popupContent);
                marker.addTo(facilityMap);
                markers.push(marker);
            });

            // Add distance circle if user location is set
            if (userLocation && distanceFilter.value !== '999') {
                const radiusKm = parseFloat(distanceFilter.value);
                distanceCircle = L.circle([userLocation.lat, userLocation.lng], {
                    radius: radiusKm * 1000,
                    color: '#667eea',
                    fillColor: '#667eea',
                    fillOpacity: 0.1,
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(facilityMap);

                // Add user location marker
                const userIcon = L.divIcon({
                    className: 'user-marker',
                    html: `<div style="
                        background: #e74c3c;
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                    "></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
                    .bindPopup('Your location')
                    .addTo(facilityMap);

                // Fit map to show all markers and the circle
                const group = L.featureGroup([...markers, distanceCircle]);
                facilityMap.fitBounds(group.getBounds().pad(0.1));
            } else if (markers.length > 0) {
                // Fit map to show all markers
                const group = L.featureGroup(markers);
                facilityMap.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function showMap() {
            mapModal.classList.add('active');
            // Small delay to ensure modal is visible before initializing map
            setTimeout(() => {
                initMap();
                facilityMap.invalidateSize();
            }, 100);
        }

        function hideMap() {
            mapModal.classList.remove('active');
        }

        viewMapBtn.addEventListener('click', showMap);
        mapModalClose.addEventListener('click', hideMap);
        mapModal.addEventListener('click', (e) => {
            if (e.target === mapModal) {
                hideMap();
            }
        });

        // Initialize app
        const savedSettings = loadSettings();
        applySettings(savedSettings);
        updateSportTheme();      // Set sport-themed background
        updateActivityFilters(); // Set up activity filters for current sport
        renderCalendar();        // Render empty calendar immediately
        fetchRealData();         // Then fetch data
    </script>
</body>
</html>